<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bingo Game - Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }

        /* Header */
        .header { background: white; padding: 15px 20px; border-radius: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .header h1 { color: #667eea; font-size: 1.2em; }
        .header-btn { background: #667eea; color: white; border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* Screens */
        .screen { display: none; }
        .screen.active { display: block; }

        /* Welcome Modal */
        .welcome-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 5000; }
        .welcome-modal.hidden { display: none; }
        .welcome-content { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px; }

        /* Card Layout */
        .cards-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .bingo-card-wrapper { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); margin-bottom: 10px; }
        
        /* Issue 2: B-I-N-G-O Headers */
        .bingo-header-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin-bottom: 5px; }
        .bingo-header-cell { text-align: center; font-weight: 900; font-size: 1.4em; color: #764ba2; border-bottom: 3px solid #764ba2; }
        
        .bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; }
        .bingo-cell { aspect-ratio: 1; background: white; border: 2px solid #667eea; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; font-weight: bold; cursor: pointer; }
        .bingo-cell.marked { background: #764ba2; color: white; }
        .bingo-cell.free { background: #ffd700; font-size: 0.7em; color: black; cursor: default; }

        /* Animation */
        @keyframes errorPulse {
            0% { transform: scale(1); background: white; }
            50% { transform: scale(1.1); background: #feb2b2; border-color: red; }
            100% { transform: scale(1); background: white; }
        }
        .error-animate { animation: errorPulse 0.8s infinite; border: 2px solid red !important; }

        /* Rolling Screen UI */
        .rolling-container { background: white; border-radius: 20px; padding: 25px; max-width: 600px; margin: 0 auto; text-align: center; }
        #currentNumber { font-size: 5em; color: #667eea; font-weight: bold; margin: 5px 0; }
        
        .recent-numbers-container { margin: 15px 0; background: #f0f4f8; padding: 15px; border-radius: 15px; overflow: visible; }
        .recent-list { display: flex; justify-content: center; gap: 15px; padding: 10px 0; overflow: visible; }
        .recent-box { background: white; color: #667eea; min-width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #667eea; }
        .recent-box:first-child { background: #667eea; color: white; transform: scale(1.3); z-index: 2; border-color: #764ba2; }

        /* Issue 3: Rolling Buttons Grid */
        .rolling-buttons-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }

        /* Overlays */
        .overlay-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2500; display: none; overflow-y: auto; padding: 20px; }
        .overlay-page.show { display: block; }
        .camera-scanner { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 4000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .camera-scanner.show { display: flex; }
        #scannerVideo { width: 90%; border-radius: 10px; border: 2px solid #48bb78; }
    </style>
</head>
<body>

    <div class="welcome-modal" id="welcomeModal">
        <div class="welcome-content">
            <h2>Bingo Party</h2>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                <button class="header-btn" id="resumeBtn" onclick="resumeGame()">üìÇ Resume Previous Game</button>
                <button class="header-btn" style="background:#48bb78" onclick="confirmStartNew()">üéÆ Start New Game</button>
            </div>
        </div>
    </div>

    <div class="header">
        <h1 id="gameTitle">Bingo Party</h1>
        <button class="header-btn" id="screenToggle" onclick="toggleScreen()">üé≤ Rolling Screen</button>
    </div>

    <div class="screen active" id="cardsScreen">
        <div class="cards-container" id="cardsContainer"></div>
        <button class="header-btn" style="width:100%; padding:20px;" onclick="addNewCard()">‚ûï Add New Card</button>
    </div>

    <div class="screen" id="rollingScreen">
        <div class="rolling-container">
            <div class="barcode-section" style="margin-bottom:20px;">
                <svg id="barcodeDisplay"></svg>
            </div>
            <div id="currentNumber">-</div>
            <div class="recent-numbers-container">
                <div class="recent-list" id="recentList"></div>
            </div>
            
            <button class="header-btn" style="width:100%; padding:15px; font-size:1.2em;" onclick="callNumber()">üé≤ Call Next Number</button>
            
            <div class="rolling-buttons-grid">
                <button class="header-btn" style="background:#805ad5" onclick="showAllNumbers()">üëÅÔ∏è View All</button>
                <button class="header-btn" style="background:#4a5568" onclick="showSettings()">‚öôÔ∏è Settings</button>
                <button class="header-btn" style="background:#ed8936; grid-column: span 2;" onclick="confirmStartNew()">üîÑ Reset Game</button>
            </div>
        </div>
    </div>

    <div class="overlay-page" id="allNumbersPage">
        <h2>Called Numbers (1-75)</h2>
        <div id="categorizedGrids"></div>
        <button class="header-btn" onclick="document.getElementById('allNumbersPage').classList.remove('show')" style="width:100%; margin-top:20px;">Close</button>
    </div>

    <div class="overlay-page" id="settingsPage">
        <h2>Settings</h2>
        <div style="margin-top:20px;">
            <label>Game Title:</label>
            <input type="text" id="titleInput" style="width:100%; padding:15px; margin:10px 0; border:2px solid #ddd; border-radius:10px;">
            <button class="header-btn" onclick="saveSettings()" style="width:100%; padding:15px;">Save & Close</button>
        </div>
    </div>

    <div class="camera-scanner" id="cameraScanner">
        <video id="scannerVideo" autoplay playsinline muted></video>
        <button class="header-btn" style="margin-top:20px; background:red;" onclick="closeScanner()">Close Scanner</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
    <script>
        let cards = [];
        let calledNumbers = [];
        let availableNumbers = Array.from({length: 75}, (_, i) => i + 1); // Fix for Issue 1
        let gameTitle = "Bingo Party";
        let codeReader = null;
        let currentScanningId = null;

        function getPrefix(num) {
            if (num <= 15) return 'B'; if (num <= 30) return 'I'; if (num <= 45) return 'N';
            if (num <= 60) return 'G'; return 'O';
        }

        // --- Logic: 15-char Hex Barcode (75 bits / 5 bits each) ---
        function generateBarcodeHex() {
            let binary = "";
            for (let i = 1; i <= 75; i++) {
                binary += calledNumbers.includes(i) ? "1" : "0";
            }
            let hex = "";
            for (let i = 0; i < binary.length; i += 5) {
                let chunk = binary.substr(i, 5);
                hex += parseInt(chunk, 2).toString(16).toUpperCase();
            }
            return hex;
        }

        function decodeHexToBinary(hex) {
            let bin = "";
            for (let i = 0; i < hex.length; i++) {
                bin += parseInt(hex[i], 16).toString(2).padStart(5, '0');
            }
            return bin;
        }

        function updateBarcode() {
            const hex = generateBarcodeHex();
            JsBarcode("#barcodeDisplay", hex, { format: "CODE128", width: 1.5, height: 60 });
        }

        // Issue 1 Fix: Population and draw logic
        function callNumber() {
            if (availableNumbers.length === 0) return alert("All numbers called!");
            const idx = Math.floor(Math.random() * availableNumbers.length);
            const num = availableNumbers.splice(idx, 1)[0];
            calledNumbers.push(num);
            
            document.getElementById('currentNumber').textContent = getPrefix(num) + "-" + num;
            updateRecentNumbers();
            updateBarcode();
            saveState();
        }

        function updateRecentNumbers() {
            const list = document.getElementById('recentList');
            list.innerHTML = '';
            [...calledNumbers].reverse().slice(0, 5).forEach(n => {
                const box = document.createElement('div');
                box.className = 'recent-box';
                box.textContent = getPrefix(n) + n;
                list.appendChild(box);
            });
        }

        // Issue 2 Fix: Card with Header
        function renderCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            cards.forEach(card => {
                const wrap = document.createElement('div');
                wrap.className = 'bingo-card-wrapper';
                
                const header = document.createElement('div');
                header.className = 'bingo-header-row';
                ['B','I','N','G','O'].forEach(l => {
                    const hCell = document.createElement('div');
                    hCell.className = 'bingo-header-cell';
                    hCell.textContent = l;
                    header.appendChild(hCell);
                });

                const grid = document.createElement('div');
                grid.className = 'bingo-grid';
                for (let r = 0; r < 5; r++) {
                    for (let c = 0; c < 5; c++) {
                        const cell = document.createElement('div');
                        cell.id = `cell-${card.id}-${r}-${c}`;
                        cell.className = `bingo-cell ${card.marked[r][c] ? 'marked' : ''} ${r==2&&c==2?'free':''}`;
                        cell.textContent = (r==2&&c==2) ? 'FREE' : card.numbers[c][r];
                        cell.onclick = () => { if(!(r==2&&c==2)) { card.marked[r][c]=!card.marked[r][c]; renderCards(); saveState(); }};
                        grid.appendChild(cell);
                    }
                }
                const b = document.createElement('button');
                b.className = 'header-btn'; b.style.width='100%'; b.style.marginTop='10px';
                b.textContent = "üì∑ Verify";
                b.onclick = () => openScanner(card.id);
                
                wrap.append(header, grid, b);
                container.appendChild(wrap);
            });
        }

        // Logic Fix: Only flagged if marked cell was NOT called
        function processScan(hex) {
            closeScanner();
            const binaryCalled = decodeHexToBinary(hex);
            const card = cards.find(c => c.id === currentScanningId);
            let errors = false;

            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    if (r === 2 && c === 2) continue;
                    const num = card.numbers[c][r];
                    const wasCalled = binaryCalled[num - 1] === '1';
                    
                    if (card.marked[r][c] && !wasCalled) {
                        errors = true;
                        const el = document.getElementById(`cell-${card.id}-${r}-${c}`);
                        if (el) {
                            el.classList.add('error-animate');
                            setTimeout(() => el.classList.remove('error-animate'), 15000);
                        }
                    }
                }
            }
            alert(errors ? "Mismatch! You marked numbers not yet called." : "Card Verified Successfully!");
        }

        // Issue 3 Functions
        function showAllNumbers() {
            const container = document.getElementById('categorizedGrids');
            container.innerHTML = '';
            const sections = [
                { l: 'B', s: 1, e: 15 }, { l: 'I', s: 16, e: 30 }, { l: 'N', s: 31, e: 45 },
                { l: 'G', s: 46, e: 60 }, { l: 'O', s: 61, e: 75 }
            ];
            sections.forEach(sec => {
                const div = document.createElement('div');
                div.innerHTML = `<h3 style="margin:10px 0; color:#667eea">${sec.l}</h3>`;
                const grid = document.createElement('div');
                grid.style.display = 'grid'; grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(40px, 1fr))'; grid.style.gap = '5px';
                for(let i=sec.s; i<=sec.e; i++) {
                    const item = document.createElement('div');
                    item.style.padding = '10px'; item.style.textAlign = 'center'; item.style.borderRadius = '5px';
                    item.style.background = calledNumbers.includes(i) ? '#48bb78' : '#edf2f7';
                    item.style.color = calledNumbers.includes(i) ? 'white' : '#333';
                    item.textContent = i;
                    grid.appendChild(item);
                }
                div.appendChild(grid);
                container.appendChild(div);
            });
            document.getElementById('allNumbersPage').classList.add('show');
        }

        function showSettings() {
            document.getElementById('titleInput').value = gameTitle;
            document.getElementById('settingsPage').classList.add('show');
        }

        function saveSettings() {
            gameTitle = document.getElementById('titleInput').value || "Bingo Party";
            document.getElementById('gameTitle').textContent = gameTitle;
            document.getElementById('settingsPage').classList.remove('show');
            saveState();
        }

        function openScanner(id) {
            currentScanningId = id;
            document.getElementById('cameraScanner').classList.add('show');
            if (!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
            codeReader.decodeFromVideoDevice(null, 'scannerVideo', (res) => { if(res) processScan(res.text); });
        }

        function closeScanner() {
            document.getElementById('cameraScanner').classList.remove('show');
            if (codeReader) codeReader.reset();
        }

        function addNewCard() {
            const card = { id: Date.now(), numbers: [], marked: [] };
            for (let col = 0; col < 5; col++) {
                let range = Array.from({length: 15}, (_, i) => i + (col * 15) + 1).sort(() => Math.random() - 0.5);
                card.numbers.push(range.slice(0, 5));
            }
            for (let r = 0; r < 5; r++) card.marked.push(Array.from({length: 5}, (_, c) => r === 2 && c === 2));
            cards.push(card);
            renderCards();
            saveState();
        }

        function toggleScreen() {
            const isCards = document.getElementById('cardsScreen').classList.toggle('active');
            document.getElementById('rollingScreen').classList.toggle('active');
            document.getElementById('screenToggle').textContent = isCards ? 'üé≤ Rolling Screen' : 'üé¥ Cards Screen';
        }

        function saveState() {
            localStorage.setItem('bingo_v3', JSON.stringify({ cards, calledNumbers, availableNumbers, gameTitle }));
        }

        function resumeGame() {
            const saved = localStorage.getItem('bingo_v3');
            if (saved) {
                const s = JSON.parse(saved);
                cards = s.cards; calledNumbers = s.calledNumbers; availableNumbers = s.availableNumbers;
                gameTitle = s.gameTitle || "Bingo Party";
                document.getElementById('gameTitle').textContent = gameTitle;
                renderCards(); updateBarcode(); updateRecentNumbers();
                document.getElementById('welcomeModal').classList.add('hidden');
            }
        }

        function confirmStartNew() {
            if(confirm("Reset the game? All cards and called numbers will be deleted.")) {
                cards = []; calledNumbers = []; availableNumbers = Array.from({length: 75}, (_, i) => i + 1);
                addNewCard();
                document.getElementById('welcomeModal').classList.add('hidden');
                document.getElementById('currentNumber').textContent = "-";
                updateBarcode(); updateRecentNumbers();
                saveState();
            }
        }

        window.onload = () => { if(!localStorage.getItem('bingo_v3')) document.getElementById('resumeBtn').style.display='none'; };
    </script>
</body>
</html>
