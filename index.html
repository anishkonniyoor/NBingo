<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bingo Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }

        /* Header */
        .header { background: white; padding: 15px 20px; border-radius: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .header h1 { color: #667eea; font-size: 1.2em; }
        .header-btn { background: #667eea; color: white; border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* Screens */
        .screen { display: none; }
        .screen.active { display: block; }

        /* Welcome Modal */
        .welcome-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 5000; }
        .welcome-modal.hidden { display: none; }
        .welcome-content { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px; }

        /* Card Layout */
        .cards-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .bingo-card-wrapper { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .bingo-header-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin-bottom: 5px; }
        .bingo-header-cell { text-align: center; font-weight: 900; font-size: 1.4em; color: #764ba2; border-bottom: 3px solid #764ba2; }
        
        .bingo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; }
        .bingo-cell { aspect-ratio: 1; background: white; border: 2px solid #667eea; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; font-weight: bold; cursor: pointer; }
        .bingo-cell.marked { background: #764ba2; color: white; }
        .bingo-cell.free { background: #ffd700; font-size: 0.7em; color: black; cursor: default; }

        /* Mismatch Animation */
        @keyframes mismatchPulse {
            0% { background-color: white; transform: scale(1); }
            50% { background-color: #feb2b2; transform: scale(1.1); border-color: red; }
            100% { background-color: white; transform: scale(1); }
        }
        .error-animate { animation: mismatchPulse 0.8s infinite; z-index: 10; border: 2px solid red !important; }

        /* Rolling Screen UI */
        .rolling-container { background: white; border-radius: 20px; padding: 25px; max-width: 600px; margin: 0 auto; text-align: center; }
        #currentNumber { font-size: 5em; color: #667eea; font-weight: bold; margin: 5px 0; }
        .barcode-section { background: #f8f9fa; padding: 10px; border-radius: 10px; margin-bottom: 15px; }
        #barcodeDisplay { max-width: 100%; height: auto; }

        /* Recent List */
        .recent-numbers-container { margin: 15px 0; background: #f0f4f8; padding: 15px; border-radius: 15px; overflow: visible; }
        .recent-list { display: flex; justify-content: center; gap: 15px; padding: 10px 0; overflow: visible; }
        .recent-box { background: white; color: #667eea; min-width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #667eea; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .recent-box:first-child { background: #667eea; color: white; transform: scale(1.25); border-color: #764ba2; z-index: 2; }

        /* Scanner Overlay */
        .camera-scanner { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 4000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .camera-scanner.show { display: flex; }
        #scannerVideo { width: 90%; border-radius: 10px; border: 2px solid #48bb78; }
    </style>
</head>
<body>

    <div class="welcome-modal" id="welcomeModal">
        <div class="welcome-content">
            <h2 id="modalTitle">Bingo Party</h2>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                <button class="header-btn" id="resumeBtn" onclick="resumeGame()">ðŸ“‚ Resume Previous Game</button>
                <button class="header-btn" style="background:#48bb78" onclick="confirmStartNew()">ðŸŽ® Start New Game</button>
            </div>
        </div>
    </div>

    <div class="header">
        <h1 id="gameTitle">Bingo Party</h1>
        <button class="header-btn" id="screenToggle" onclick="toggleScreen()">ðŸŽ² Rolling Screen</button>
    </div>

    <div class="screen active" id="cardsScreen">
        <div class="cards-container" id="cardsContainer"></div>
        <button class="header-btn" style="width:100%; padding:20px;" onclick="addNewCard()">âž• Add New Card</button>
    </div>

    <div class="screen" id="rollingScreen">
        <div class="rolling-container">
            <div class="barcode-section"><svg id="barcodeDisplay"></svg></div>
            <div>
                <h3>Called Number</h3>
                <div id="currentNumber">-</div>
            </div>

            <div class="recent-numbers-container">
                <p style="font-weight:bold; margin-bottom:5px; color:#4a5568;">Last 5 Numbers</p>
                <div class="recent-list" id="recentList"></div>
            </div>

            <button class="header-btn" style="width:100%; padding:15px; font-size:1.2em;" onclick="callNumber()">ðŸŽ² Call Next Number</button>
            <button class="header-btn" style="width:100%; margin-top:10px; background:#ed8936" onclick="confirmStartNew()">ðŸ”„ Reset Game</button>
        </div>
    </div>

    <div class="camera-scanner" id="cameraScanner">
        <video id="scannerVideo" autoplay playsinline muted></video>
        <button class="header-btn" style="margin-top:20px; background:red;" onclick="closeScanner()">Close Scanner</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

    <script>
        // --- State Management ---
        let cards = [];
        let calledNumbers = [];
        let availableNumbers = Array.from({length: 75}, (_, i) => i + 1);
        let codeReader = null;
        let currentScanningId = null;

        function getPrefix(num) {
            if (num <= 15) return 'B'; if (num <= 30) return 'I'; if (num <= 45) return 'N';
            if (num <= 60) return 'G'; return 'O';
        }

        // --- Persistence ---
        function saveState() {
            localStorage.setItem('bingo_state', JSON.stringify({ cards, calledNumbers, availableNumbers }));
        }

        function resumeGame() {
            const saved = localStorage.getItem('bingo_state');
            if (saved) {
                const state = JSON.parse(saved);
                cards = state.cards;
                calledNumbers = state.calledNumbers;
                availableNumbers = state.availableNumbers;
                renderCards();
                updateBarcode();
                updateRecentNumbers();
                document.getElementById('welcomeModal').classList.add('hidden');
            }
        }

        function confirmStartNew() {
            if(confirm("Start a new game? This clears all cards and history.")) {
                cards = []; calledNumbers = [];
                availableNumbers = Array.from({length: 75}, (_, i) => i + 1);
                addNewCard();
                updateBarcode();
                updateRecentNumbers();
                document.getElementById('currentNumber').textContent = "-";
                document.getElementById('welcomeModal').classList.add('hidden');
                saveState();
            }
        }

        // --- Card Logic ---
        function addNewCard() {
            const card = { id: Date.now(), numbers: [], marked: [] };
            for (let col = 0; col < 5; col++) {
                let nums = Array.from({length: 15}, (_, i) => i + (col * 15) + 1).sort(() => Math.random() - 0.5);
                card.numbers.push(nums.slice(0, 5));
            }
            for (let r = 0; r < 5; r++) card.marked.push(Array.from({length: 5}, (_, c) => r === 2 && c === 2));
            cards.push(card);
            renderCards();
            saveState();
        }

        function renderCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            cards.forEach(card => {
                const wrap = document.createElement('div');
                wrap.className = 'bingo-card-wrapper';
                
                const header = document.createElement('div');
                header.className = 'bingo-header-row';
                ['B','I','N','G','O'].forEach(l => {
                    const hCell = document.createElement('div');
                    hCell.className = 'bingo-header-cell';
                    hCell.textContent = l;
                    header.appendChild(hCell);
                });

                const grid = document.createElement('div');
                grid.className = 'bingo-grid';
                for (let r = 0; r < 5; r++) {
                    for (let c = 0; c < 5; c++) {
                        const cell = document.createElement('div');
                        cell.id = `cell-${card.id}-${r}-${c}`;
                        cell.className = `bingo-cell ${card.marked[r][c] ? 'marked' : ''} ${r === 2 && c === 2 ? 'free' : ''}`;
                        cell.textContent = (r === 2 && c === 2) ? 'FREE' : card.numbers[c][r];
                        cell.onclick = () => { 
                            if(!(r===2 && c===2)) { 
                                card.marked[r][c] = !card.marked[r][c]; 
                                renderCards(); 
                                saveState(); 
                            } 
                        };
                        grid.appendChild(cell);
                    }
                }

                const btn = document.createElement('button');
                btn.className = 'header-btn';
                btn.style.width = '100%'; btn.style.marginTop = '15px';
                btn.textContent = 'ðŸ“· Verify Card';
                btn.onclick = () => openScanner(card.id);

                wrap.appendChild(header);
                wrap.appendChild(grid);
                wrap.appendChild(btn);
                container.appendChild(wrap);
            });
        }

        // --- Rolling Logic ---
        function callNumber() {
            if (availableNumbers.length === 0) return;
            const idx = Math.floor(Math.random() * availableNumbers.length);
            const num = availableNumbers.splice(idx, 1)[0];
            calledNumbers.push(num);
            
            document.getElementById('currentNumber').textContent = getPrefix(num) + "-" + num;
            
            // Auto-mark
            cards.forEach(card => {
                for(let c=0; c<5; c++) {
                    for(let r=0; r<5; r++) { if(card.numbers[c][r] === num) card.marked[r][c] = true; }
                }
            });

            updateRecentNumbers();
            updateBarcode();
            renderCards();
            saveState();
        }

        function updateRecentNumbers() {
            const list = document.getElementById('recentList');
            list.innerHTML = '';
            const recent = [...calledNumbers].reverse().slice(0, 5);
            recent.forEach(n => {
                const box = document.createElement('div');
                box.className = 'recent-box';
                box.textContent = getPrefix(n) + n;
                list.appendChild(box);
            });
        }

        function updateBarcode() {
            let bin = "";
            for (let i = 1; i <= 75; i++) bin += calledNumbers.includes(i) ? "1" : "0";
            while (bin.length % 4 !== 0) bin += "0";
            let hex = "";
            for (let i = 0; i < bin.length; i += 4) hex += parseInt(bin.substr(i, 4), 2).toString(16).toUpperCase();
            JsBarcode("#barcodeDisplay", hex, { format: "CODE128", width: 1.5, height: 60 });
        }

        // --- Scanner Logic ---
        function openScanner(id) {
            currentScanningId = id;
            document.getElementById('cameraScanner').classList.add('show');
            if (!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
            codeReader.decodeFromVideoDevice(null, 'scannerVideo', (res) => { if(res) processScan(res.text); });
        }

        function processScan(hexData) {
            closeScanner();
            let binaryMap = "";
            for (let i = 0; i < hexData.length; i++) {
                binaryMap += parseInt(hexData[i], 16).toString(2).padStart(4, '0');
            }

            const card = cards.find(c => c.id === currentScanningId);
            if (!card) return;

            let mismatch = false;
            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    if (r === 2 && c === 2) continue;
                    const num = card.numbers[c][r];
                    const actuallyCalled = binaryMap[num - 1] === '1';
                    if (card.marked[r][c] !== actuallyCalled) {
                        mismatch = true;
                        const el = document.getElementById(`cell-${card.id}-${r}-${c}`);
                        if (el) {
                            el.classList.add('error-animate');
                            setTimeout(() => el.classList.remove('error-animate'), 15000);
                        }
                    }
                }
            }
            alert(mismatch ? "âŒ Mismatch! Check the pulsing cells." : "âœ… Card is correct!");
        }

        function closeScanner() {
            document.getElementById('cameraScanner').classList.remove('show');
            if (codeReader) codeReader.reset();
        }

        function toggleScreen() {
            const isCards = document.getElementById('cardsScreen').classList.toggle('active');
            document.getElementById('rollingScreen').classList.toggle('active');
            document.getElementById('screenToggle').textContent = isCards ? 'ðŸŽ² Rolling Screen' : 'ðŸŽ´ Cards Screen';
        }

        window.onload = () => { if (!localStorage.getItem('bingo_state')) document.getElementById('resumeBtn').style.display = 'none'; };
    </script>
</body>
</html>
